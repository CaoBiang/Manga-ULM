# 性能优化（设计）

## 设计目的

- 避免阅读时整本漫画解压到内存导致内存暴涨。
- 降低大量翻页或批量扫描时的重 I/O 与 CPU 消耗。
- 统一 Zip/Rar/7z 处理逻辑，确保“按需解压 + 缓存”行为一致。

## 整体设计

- 通过统一的归档读取抽象（`ArchiveReader`）建立“索引缓存”，并在读取页图时按需解压。
- 阅读接口按页流式输出，避免一次性读取/解压整包。
- 对于高分辨率页面：支持在请求页图时携带缩放参数，由后端按需缩放并重新编码，降低前端渲染压力，并可作为缓解摩尔纹的手段。
- 扫描采用“增量判定 + 只读目录索引”，封面生成仅解压 1 张候选页，避免逐页解码带来的峰值开销。

```mermaid
flowchart TD
  "前端请求某一页（可带缩放参数）" --> "后端读取索引（缓存）"
  "后端读取索引（缓存）" --> "按需解压目标页（Zip/Rar/7z）"
  "按需解压目标页（Zip/Rar/7z）" --> "判断是否需要缩放"
  "判断是否需要缩放" -->|"否"| "流式响应返回原图"
  "判断是否需要缩放" -->|"是"| "Pillow 缩放 + 重采样 + 重新编码"
  "Pillow 缩放 + 重采样 + 重新编码" --> "返回缩放后图片"
```

## 模块介绍

- `apps/api/app/infrastructure/archive_reader.py`：索引缓存、按页解压、流式输出、MIME 判定。
- `apps/api/app/api/v1/files.py`：`/files/<id>/page/<page_num>` 以流式响应返回图片，降低峰值内存。
- `apps/api/app/tasks/scanner.py`：增量扫描、索引读取与封面生成（单页候选），避免全量解压/解码。

## 使用建议

- 阅读器前端按页拉取即可获得最佳体验，无需额外配置。
- 若需要重新生成封面：清理 `instance/covers` 后重新扫描。
